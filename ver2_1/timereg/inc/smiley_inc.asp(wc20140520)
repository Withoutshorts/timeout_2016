
<%


sub sweekmsg
%>
 <br /><b><%=session("user") &"</b> "& lcase(tsa_txt_087) %>?</b><br /><%=tsa_txt_383 %> 

	           
<%
end sub


'public sidstedagisidsteAfsluge
function afslutuge(weekSelected, visning)%>


<form action="timereg_akt_2006.asp?func=opdatersmiley&fromsdsk=<%=fromsdsk%>" method="POST">
<table border='0' cellspacing='0' cellpadding='0' width="100%">

<tr>
   
	<td valign=top bgcolor="#FFFFFF" style="padding-top:0px;">

        
   
	<%
	
	    if visning = 0 then 'denne uge
        sidsteUgeTxt = "valgte uge"
        sidstedagisidsteuge = dateadd("d", -7, weekSelected)
        else
        sidsteUgeTxt = "sidste uge"
        sidstedagisidsteuge = dateadd("d", -7, weekSelected)
        end if
	    
	    

        ugeNrAfsluttet = "1-1-2044"
		detteaar = datepart("yyyy", sidstedagisidsteuge)
		sidstedagiuge = datepart("ww", sidstedagisidsteuge, 2, 2) 

        'if lto = "dencker" then
        'Response.write "sidstedagisidsteuge:" & sidstedagisidsteuge
        'end if

        call rettidigafsl(sidstedagisidsteuge)

	   
		
        'Response.write sidstedagiuge

		call erugeAfslutte(detteaar, sidstedagiuge, usemrn)
        
        call afsluttedeUger(detteaar, usemrn)
		
        if cint(sidsteUgenrAfslFundet) = 1 then
        sidstedagisidsteAfsluge = dateAdd("d", 7, sidsteUgenrAfsl) 
        else
        sidstedagisidsteAfsluge = sidsteUgenrAfsl 
        end if


                    '*** Sikrer at sidste ugedag der er fundet altid er søndag. (sidstedag i ugen) *** 
                     dayOfWeekThis = datePart("w",sidstedagisidsteAfsluge,2,2)
                    '1 = (dayOfWeek - d) 
                    dThis = (dayOfWeekThis - 1)
                    firstdayOfFirstWeekThis = dateAdd("d", -dThis, sidstedagisidsteAfsluge)
                    firstThursdayOfFirstWeekThis = dateAdd("d", +6, firstdayOfFirstWeekThis)
            
                    sidstedagisidsteAfsluge = firstThursdayOfFirstWeekThis
                    'sidstedagisidsteAfsluge = dateAdd("d", 7, sidstedagisidsteAfsluge)



        call meStamdata(usemrn)
        
        sidstedagisidsteugeTjk = sidstedagisidsteuge
        if (cDate(meAnsatDato) > cDate(sidstedagisidsteugeTjk) OR cDate(meOpsagtDato) < cDate(sidstedagisidsteugeTjk)) then

        %>
        <div style="background-color:#ffdfdf; padding:3px;">
        <%=tsa_txt_405%>.<br />
         <%=tsa_txt_406%>: <%=meAnsatDato %> (<%=tsa_txt_005 %>: <%=datepart("ww", meAnsatDato, 2,2) %>) - <%=meOpsagtDato %> 
            <br /><%=tsa_txt_407%>: <%=datepart("ww", sidstedagisidsteugeTjk, 2,2) %>
            </div>

        <%
        else

		if cint(showAfsuge) = 1 then%>
		
			
		
				<%
				'*** Man må gerne lukke uger frem i tiden 27012009 ***'
				'if (datepart("ww", tjekdag(7), 2, 2) <= datepart("ww", now, 2, 2) AND year(tjekdag(7)) <= year(now)) OR  year(tjekdag(7)) < year(now) then%>
				<input type="hidden" name="FM_mid" id="FM_mid" value="<%=usemrn%>">
				<input type="hidden" name="FM_afslutuge_sidstedag" id="FM_afslutuge_sidstedag" value="<%=sidstedagisidsteAfsluge%>"><!-- sidstedagisidsteAfsluge -->


               
                <% if sidsteUgenrAfslFundet = 1 then %>
                <%=tsa_txt_408 %>: <b><%=datePart("ww", sidsteUgenrAfsl, 2,2) &", "& datePart("yyyy", sidsteUgenrAfsl, 2,2) %> </b> 
                <%end if %>
                
                <%if datepart("ww", sidstedagisidsteuge, 2, 2) > 1 then 
                %>
                <h4><span style="font-size:11px;"><%=tsa_txt_409 %>:</span>

                <%if cDate(cDateUge) < cDate(now) then
                bgcolmsgafslut = "red"
                else
                bgcolmsgafslut = "#999999"
                end if     
                %>
               
                <br />
                <%=tsa_txt_005 %>: <%=datePart("ww", sidstedagisidsteAfsluge, 2,2) %>, <%=datePart("yyyy", sidstedagisidsteAfsluge, 2,2) %>

                     <br /><span style="font-size:11px; color:<%=bgcolmsgafslut%>; font-weight:lighter;">
                <%=tsa_txt_410 %> <b><%=left(weekdayname(weekday(cDateUge,1)), 3) &".  kl. "& formatdatetime(cDateUge, 3) %> </b> <%=weekafslTxt %>

                  
                </span>    

                </h4>
                <%
                    
                 if cint(afslutugekri) = 0 OR cint(level) = 1 then 'Må ikke kune afslutte alle uger når der er Kriterier opstillet på min. timer pr. uge%>
				<input type="checkbox" name="FM_afslutuge" id="FM_afslutuge" value="1" onClick="showlukalleuger()">
                <%else %>
                <input type="checkbox" name="FM_afslutuge" id="FM_afslutuge" value="1">
                <%end if %>
                <span><%=tsa_txt_089 %>  
                    
                    <%if datepart("ww", tjekdag(7), 2 ,2) <> datepart("ww", sidstedagisidsteAfsluge, 2 ,2) then  %>
                    (<a href="timereg_akt_2006.asp?showakt=1&strdag=<%=day(sidstedagisidsteAfsluge)%>&strmrd=<%=month(sidstedagisidsteAfsluge)%>&straar=<%=year(sidstedagisidsteAfsluge)%>" class="vmenu">gå til uge <%=datePart("ww", sidstedagisidsteAfsluge, 2,2) %></a>)</span> 
                    <%end if %>

                
                &nbsp;&nbsp;<input type="submit" value="<%=tsa_txt_087 %> >>" style="font-size:9px;">
                


                <!--<%else %>
                <input type="checkbox" name="FM_afslutuge" id="Checkbox1" value="1"><span><%=tsa_txt_089 %> <b><%=sidstedagiuge &" "& detteaar%></b> </span>
                   -->

                <%end if %>
				
				<!--<font class=megetlillesort>Ved markering inden søndag kl. 24:00 vil denne uge betragtes som rettidigt afsluttet.</font><br>-->
				

                
                	<div id="lukalleuger" name="lukalleuger" style="position:relative; visibility:hidden; display:none;">
                <br />         
                <%LastWeekSelected = dateAdd("d", -7, now) %>
				<input type="checkbox" name="FM_alleuger" id="FM_alleuger" value="1"><span><%=tsa_txt_090 %>: <%=datePart("ww", LastWeekSelected, 2,2) %>, <%=datePart("yyyy", LastWeekSelected, 2,2) %></span>
				</div>
				 
            <br /><br />
                <%if cint(afslProcKri) = 1 then
                   sm_bdcol = "#6CAE1C"
                   else
                    sm_bdcol = "red"
                   end if %>


                <div style="color:#000000; padding:5px; border:1px <%=sm_bdcol%> solid;"><%=tsa_txt_398 %>: <%=totTimerWeek %> 
                    
                    <%if afslutugekri = 2 then %>
                    <%=tsa_txt_399 %>
                    <%end if %>

                    <%=" "&tsa_txt_140 %> / <%=afslutugeBasisKri %> = <b><%=afslProc %> %</b> <%=tsa_txt_095 %> <b><%=datePart("ww", tjkTimeriUgeDtTxt, 2,2) %></b>
                      <br />(<%=left(weekdayname(weekday(formatdatetime(tjkTimeriUgeDt, 2))), 3) &". "& formatdatetime(tjkTimeriUgeDt, 2)%> - <%= left(weekdayname(weekday(formatdatetime(dateAdd("d", 6, tjkTimeriUgeDt), 2))), 3) &". "&formatdatetime(dateAdd("d", 6, tjkTimeriUgeDt), 2) %>)
               

                   </div>
               
                
            
			
				
				<!--
				<else>
				<br />
				<font class=megetlillesort><=tsa_txt_005 %> <b><=datepart("ww", tjekdag(7), 2, 2)%></b> <=tsa_txt_091 %> <=weekdayname(weekday(tjekdag(1)))%>  <=tsa_txt_092 %> <b><=formatdatetime(tjekdag(1), 2) %></b>
				<end if>
				-->
		<%else%><br>
		<b><%=tsa_txt_005 %>&nbsp;<%=sidstedagiuge%>&nbsp;<%=tsa_txt_093 %> <font color=green><i>V</i></font></b>
		<br><%=tsa_txt_093 %>&nbsp;<%=weekdayname(weekday(cdAfs))%>&nbsp;<%=tsa_txt_092 %>&nbsp;<%=formatdatetime(cdAfs, 2)%>&nbsp;<%=formatdatetime(cdAfs, 3)%> 
		(<%=tsa_txt_095 %>&nbsp;<%=datepart("ww", cdAfs, 2, 2)%>)
		<%end if%>


       

        <%end if %>
	
	
	</td>
	</tr>
</table> 
 </form>
<%end function%>




<%


public antalAfsDato, useDateSmileyTjkWeek
function showsmiley(weekSelected, visning)

 '***************************** Smiley ******************************
	%>
	<table border='0' cellspacing='0' cellpadding='0' width=100%>
	<tr bgcolor="#FFFFFF"><td style="padding:5px 5px 5px 5px;">
	<%
	
	'**** Sur Smiley overruler ******'
	antalAfsDato = 0

    'sætter useDateSmileyTjk = sidste uge
	if visning = 1 then 'sidste uge
    useDateSmileyTjk = dateadd("d", -7, weekSelected)
    useDateSmileyTjk2 = dateadd("d", -8, weekSelected) '14
	else
    useDateSmileyTjk = dateadd("d", -7, weekSelected)
    useDateSmileyTjk2 = dateadd("d", -8, weekSelected)
    end if


    call meStamdata(usemrn)


    
    if year(meAnsatDato) >= year(useDateSmileyTjk) then
            
            'if year(meAnsatDato) >= year(now) then
            surDatoSQLSTART = year(meAnsatDato)&"/"& month(meAnsatDato)&"/"& day(meAnsatDato)
            useDateSmileyTjkWeek = dateDiff("ww", meAnsatDato, now, 2, 2)
            'else
            'surDatoSQLSTART = year(now)&"/1/1"
            'useDateSmileyTjkWeek = dateDiff("ww", surDatoSQLSTART, now, 2, 2)
            'end if
    
     else
                    '** Første Torsdag så vi er sikker på at vi er inde i uge 1
                    surDatoSQLSTART = year(useDateSmileyTjk)&"/1/1"
                    dayOfWeekThis = datePart("w",surDatoSQLSTART,2,2)

                    dThis = (dayOfWeekThis - 1)
                    firstdayOfFirstWeekThis = dateAdd("d", -dThis, surDatoSQLSTART)
                    surDatoSQLSTART = firstdayOfFirstWeekThis 'dateAdd("d", +3, firstdayOfFirstWeekThis)
                    surDatoSQLSTART = year(surDatoSQLSTART)&"/"& month(surDatoSQLSTART)&"/"& day(surDatoSQLSTART)

            useDateSmileyTjkWeek = datepart("ww", useDateSmileyTjk, 2, 2)
    
    end if


    if cDate(meOpsagtDato) < cDate(useDateSmileyTjk2) then
       surDatoSQLEND = year(meOpsagtDato)&"/"& month(meOpsagtDato)&"/"& day(meOpsagtDato)
    else
       surDatoSQLEND = year(useDateSmileyTjk2)&"/"&month(useDateSmileyTjk2)&"/"&day(useDateSmileyTjk2)
    end if
	
	
	antalAfsDato = 0

	strSQL3 = "SELECT uge, count(afsluttet) AS antalafs FROM ugestatus "_
	&" WHERE mid = "& usemrn &" AND uge BETWEEN '"& surDatoSQLSTART &"' AND '"& surDatoSQLEND &"'"_
	&" GROUP BY mid ORDER BY afsluttet DESC"
    'if lto = "dencker" then
	'Response.write strSQL3 & "<br><br>useDateSmileyTjkWeek: "& useDateSmileyTjkWeek & "<br>" & strSQL3 &"<br>"
	'Response.flush
    'end if
	oRec3.open strSQL3, oConn, 3 
	if not oRec3.EOF then
		antalAfsDato = antalAfsDato + oRec3("antalafs")
	end if
	oRec3.close  
	
	'if lto = "dencker" then
	'Response.write "lastAfsDatoWeek: " & antalAfsDato+1 & " >= "&  useDateSmileyTjkWeek
	'end if

	
	'** Glade ***'
	if (antalAfsDato+1) >= useDateSmileyTjkWeek then
	surSmil = 0
	else
	surSmil = 1
	end if
	
	smileyRnd = right(cint(Second(now)), 1)
	
	select case smileyRnd
	case 0, 1 
	smilVal = 1
	case 2, 3
	smilVal = 2
	case 4, 5
	smilVal = 3
	case 6, 7
	smilVal = 4
	case else
	smilVal = 5
	end select
		
		%>
		<b><%=meNavn %></b> <span style="color:#000000; font-size:9px;"> - <%=tsa_txt_404 %>: <%=formatdatetime(meAnsatDato, 2) %></span><br />
		<%=tsa_txt_411 &" "& lcase(tsa_txt_005) &" "& datepart("ww", useDateSmileyTjk2, 2, 2) &" "& year(useDateSmileyTjk2)%>:
		<%	
		if cint(surSmil) = 1 then%>
				
				<b><%=tsa_txt_096 %></b><!--(du har afsluttet: <b><%=antalAfsDato %> / <%=useDateSmileyTjkWeek %></b> uger)--></td><td align=right style="padding:2px 5px 0px 0px;"><a href="#" class="sA1_k">[x]</a></td></tr>
	            <tr><td colspan=2 style="padding-top:3px;">
				<img src="../ill/sur_<%=smilVal%>.gif" alt="" style="border:0px;"><br>
				
                   <span style="color:red;"><%=tsa_txt_403 %>!</span> 
			
				<%if showweekmsg = "j" then %>
				<%'call sweekmsg %>
		        <%end if%>
				
				
				<%
		else
		
				
				%>
				<b><%=tsa_txt_098 %></b>
				</td><td align=right style="padding:2px 5px 0px 0px;"><a href="#" class="sA1_k">[x]</a></td></tr>
	            <tr><td colspan=2 style="padding-top:3px;">
				<img src="../ill/gladsmil_<%=smilVal%>.gif" alt="" style="border:0px;"><br>
				
				<%if showweekmsg = "j" then %>
				<%'call sweekmsg %>
		        <%end if%>
		        <%
				'**else MELLEmFornøjet findes IKKE mere
				%>
                <!--
				<b><%=tsa_txt_099 %></b> (<%=tsa_txt_100 %>)</td><td align=right style="padding:2px 5px 0px 0px;"><a href="#" class="sA1_k">[x]</a></td></tr>
	            <tr><td colspan=2 style="padding-top:3px;">
				<img src="../ill/mellemsmil_<%=smilVal%>.gif" alt="" style="border:0px;"><br>
                -->
			
				<%
		end if%>
		

                   
		<!--<font class=megetlillesort><br>Nb: Smileyordning kan slås til og fra i medarbejder-profilen.</font>-->
		
	
	
	
	</td></tr>
		</table>
<%end function%>



<%
function smileystatus(medarbid, visning)






if len(medarbid) <> 0 then
medarbid = cint(medarbid)
else
medarbid = 0
end if


    '**** Timereg *************
    'if thisfile <> "smileystatus.asp" then
    
    'if cint(year(now)) = cint(useYear) then
	'denneuge = datepart("ww", year(now)&"/"&month(now)&"/"&day(now), 2, 2)
	'else
	'	if cint(year(now)) < cint(useYear) then
	'	denneuge = 0
'		else
	'	denneuge = 52
	'	end if
	'end if
	
	startdato = useYear&"/1/1"
	slutdato = useYear&"/12/31"

    startdatoBeregn = "1/1/"& useYear
	slutdatoBeregn = now

	'else
    '***** Smiley Stat '**************
	
    'startdato = strAar&"/"&strMrd&"/"&strDag
	'slutdato = strAar_slut&"/"&strMrd_slut&"/"&strDag_slut
	
	'startdatoBeregn = strDag&"/"&strMrd&"/"&strAar
	'slutdatoBeregn = strDag_slut&"/"&strMrd_slut&"/"&strAar_slut
	'denneuge = datediff("ww", startdatoBeregn, slutdatoBeregn, 2,2)
	
	'end if
	
	'Response.write denneuge
	'Response.write "thisfile: "& thisfile

	'antaluger = datediff("ww", cdate(startdato), cdate(slutdato), 2, 3)
	'Response.flush
	
	dim glade, sure, mnavn, mnr, ugerafsluttet, sletafsl, mansatDato
	Redim glade(500), sure(500), mnavn(500), mnr(500), mansatDato(500)
	
	m = 100
	v = 6000 '5200
	redim ugerafsluttet(m,v) 
	redim sletafsl(m,v) 
	redim yearaf(m,v)
	
	'Response.write medarbid
	
	if cint(medarbid) <> 0 then
	medarbKri = " m.mid = "& medarbid 
	else
	medarbKri = " mansat <> 2 AND mansat <> 3 " 
	end if
	
	strSQL = "SELECT m.mid AS mid, m.mnavn, m.mnr, m.ansatdato FROM medarbejdere m"_
	&" WHERE "& medarbKri &" ORDER BY m.mid"
	oRec.open strSQL, oConn, 3 
	
	'Response.write strSQL & "<hr>"
	
	x = 0
	lastmid = 0
	while not oRec.EOF 
	
	'Response.write lastmid &"<>"& oRec("mid") &"<br>"
	
		x = x + 1
		lastmid = oRec("mid")
		'Redim preserve mnavn(x)
        'Redim preserve mansatDato(x)
		'Redim preserve mnr(x)
		'Redim preserve glade(x)
		'Redim preserve sure(x)
		
		
        mansatDato(x) = oRec("ansatdato")
		mnavn(x) = oRec("mnavn")
		mnr(x) = oRec("mnr")
		
		'Response.write mnavn(x) & "<br>"
		        
                    if datepart("yyyy", oRec("ansatdato"), 2,2) >= datepart("yyyy", startdato, 2,2) then
                    tjkAnsatDatoKri = "AND (uge >= '"& year(oRec("ansatdato")) &"/"& month(oRec("ansatdato"))&"/"& day(oRec("ansatdato")) &"')"
                    else
                    tjkAnsatDatoKri = ""
                    end if
        
					strSQL2 = "SELECT u.status, u.afsluttet, u.uge, u.id FROM ugestatus u WHERE u.mid = "& oRec("mid") &" AND (uge BETWEEN '"& startdato &"' AND '"& slutdato &"') "& tjkAnsatDatoKri &" ORDER BY uge" 
					'AND (WEEK(uge,1) BETWEEN 1 AND "& denneuge &" 
					
                    'if session("mid") = 1 then
					'Response.write strSQL2 &"<br>"
	                'end if				

					v = 0
					oRec2.open strSQL2, oConn, 3 
					while not oRec2.EOF 
					
					if v = 0 AND datepart("ww", oRec2("uge"), 2, 2) = 52 then
					
					else
					
					if oRec2("status") = 2 then
					glade(x) = glade(x) + 1
					        
					        if level = 1 AND thisfile <> "timereg_akt_2006" then
						    ugerafsluttet(x,v) = "<a href=smileystatus.asp?func=slet&id="&oRec2("id")&" class=vmenuglobal>"&datepart("ww", oRec2("uge"), 2, 2)&"</a>"
					        else
					        ugerafsluttet(x,v) = "<b>"&datepart("ww", oRec2("uge"), 2, 2)&"</b>"
					        end if
					        
					else
					sure(x) = sure(x) + 1
					        if level = 1 AND thisfile <> "timereg_akt_2006" then
						    ugerafsluttet(x,v) = "<a href=smileystatus.asp?func=slet&id="&oRec2("id")&" class=vmenualt>"&datepart("ww", oRec2("uge"), 2, 2)&"</a>"
					        else
					        ugerafsluttet(x,v) = datepart("ww", oRec2("uge"), 2, 2) 
					        end if
					end if
					
					sletafsl(x,v) = oRec2("id")
					yearaf(x,v) = datepart("yyyy", oRec2("uge"), 2, 2)
					v = v + 1
					
					end if
					
					
					oRec2.movenext
					wend
					oRec2.close 


	
	oRec.movenext
	wend
	oRec.close 
	
	antalx = x
	'Response.write x
	
	%>
	

<%if thisfile <> "smileystatus.asp" then
twdt = "725"
else
twdt = "805"
end if

if thisfile <> "smileystatus.asp" then 'fra tiemreg. siden
dvdsp = "none"
dvwzb = "hidden"
else
dvdsp = ""
dvwzb = "visible"
end if
%>	

<div id="dv_ugeafslutninger" style="position:relative; display:<%=dvdsp%>; visibility:<%=dvwzb%>;">

<table border=0 cellspacing=0 cellpadding=0 width="<%=twdt%>">

<tr bgcolor="#5c75AA">
    <td>&nbsp;</td>
	<td width=400 class=alt><b><%=tsa_txt_101 %></b></td>
	<td class=alt align=right><b><%=tsa_txt_102 %></b></td>
	<td class=alt align=right><b><%=tsa_txt_103 %></b><br />afsluttet for sent</td>
	<td class=alt align=right><b><%=tsa_txt_104 %></b></td>
	<td valign=top style="padding:1px 5px 2px 10px;">
	<%if visning = 100 then %>
	<a href="#" id="sA2_k" class=red><b>[x]</b></a>
	<%else %>
	&nbsp;
	<%end if %>
	</td>
    <td>&nbsp;</td>
</tr>

	
	<%
	
	
	
	lastyear = 2000
	'Response.flush
	if x <> 0 then
			for x = 1 to antalx ' - 1
			
			select case right(x, 1)
	case 0,2,4,6,8
	trbg = "#FFFFFF"
	case else
	trbg = "#Eff3ff"
	end select

          if thisfile <> "smileystatus.asp" then
          
        if year(mansatDato(x)) = year(startdatoBeregn) then
          antalUger = datediff("ww", mansatDato(x), slutdatoBeregn, 2,2)
          else
               if year(mansatDato(x)) < year(startdatoBeregn) then
               antalUger = datediff("ww", startdatoBeregn, slutdatoBeregn, 2,2) 
               else
               antalUger = 0 'datediff("ww", startdatoBeregn, slutdatoBeregn, 2,2)
               end if
          end if
        
          else

                if year(mansatDato(x)) >= year(startdatoBeregn) then
                antalUger = datediff("ww", mansatDato(x), slutdatoBeregn, 2,2)
                else
                antalUger = datediff("ww", startdatoBeregn, slutdatoBeregn, 2,2) 
                end if


           end if


           if antalUger < 0 then
           antalUger = 0
           end if

			
			%>
			<tr bgcolor="<%=trbg %>">
				<td height=20>&nbsp;</td>
				<td><b><%=mnavn(x)%> (<%=mnr(x)%>)</b><br />
                    <span style="color:#5582d2; font-size:9px;"><%=tsa_txt_404 %>: <%=formatdatetime(mansatDato(x), 2) %></span>
				</td>
				<td align=right><b><%=glade(x)%></b></td>
				<td align=right><%=sure(x)%></td>
				<td align=right><%=glade(x)+sure(x)%> / <%=antalUger%></td>
				<td>&nbsp;</td>
				<td>&nbsp;</td>
			</tr>
			<tr bgcolor="<%=trbg %>"><td colspan=7 style="padding:5px;">
				<span style="font-size:9px; color:#999999;"><i><%=tsa_txt_105 %>:</i></span>
				<%
				for v = 0 to UBOUND(ugerafsluttet, 1)
				if len(ugerafsluttet(x,v)) <> 0 then%>
					
					<%if right(v, 1) = 0 AND v > 0 then%>
					<br>
					<%end if%>
					
					<%if lastyear <> yearaf(x,v) then %>
					<br /><b><%=yearaf(x,v)%></b><br />
					<%end if %>
					
				 		- <%=ugerafsluttet(x,v)%>
				 		
				<%	
				
				lastyear = yearaf(x,v)
				end if
				next
				%>
			</td></tr>
			
			<%next
	else%>
	<tr bgcolor="#ffffff">
		<td style="height:100px;">&nbsp;</td>
		<td colspan=5 style=padding-left:20px;><%=tsa_txt_106 %></td>
		<td>&nbsp;</td>
	</tr>
	<%end if%>
	
	<%if visning <> 1 then %>
	<tr bgcolor="#5C75AA">
		<td style="height:20px">&nbsp;</td>
		<td colspan=5>&nbsp;</td>
		<td>&nbsp;</td>
	</tr>
	<%else %>
	<tr bgcolor="#FFFFFF">
		<td style="height:20px">&nbsp;</td>
		<td colspan=5>&nbsp;</td>
		<td>&nbsp;</td>
	</tr>
	
	<%end if %>
	


    </table>
    </div>


	<%end function%>
	
	
	
	
	<% 
    	public cDateUge, cDateAfs, cDateUgeTilAfslutning, smileysttxt, smileyImg, weekafslTxt
        function rettidigafsl(ugeVal)


                cDateUgeTilAfslutning = year(ugeVal) &"/"& month(ugeVal) &"/"& day(ugeVal)
		        
		        select case lcase(lto)
                case "intranet - local"
                cDateUge = dateadd("d", -2, year(ugeVal) &"/"& month(ugeVal) &"/"& day(ugeVal) &" 14:00:00")
		        cDateAfs = year(now) &"/"& month(now) &"/"& day(now) &" "& time
                weekafslTxt = "i samme uge"
                case "epi", "epi_osl", "epi_sta", "kejd_pb", "kejd_pb2", "epi_ab"
		        cDateUge = dateadd("d", 1, year(ugeVal) &"/"& month(ugeVal) &"/"& day(ugeVal) &" 12:00:00")
		        cDateAfs = year(now) &"/"& month(now) &"/"& day(now) &" "& time
                weekafslTxt = "i den følgende uge"
                case "mi"
		        cDateUge = dateadd("d", 1, year(ugeVal) &"/"& month(ugeVal) &"/"& day(ugeVal) &" 16:30:00")
		        cDateAfs = year(now) &"/"& month(now) &"/"& day(now) &" "& time
                weekafslTxt = "i den følgende uge"
		        case "lw", "synergi1"
		        cDateUge = dateadd("d", 1, year(ugeVal) &"/"& month(ugeVal) &"/"& day(ugeVal) &" 12:00:00")
		        cDateAfs = year(now) &"/"& month(now) &"/"& day(now) &" "& time
		         weekafslTxt = "i den følgende uge"
                case "dencker" 
		        cDateUge = dateadd("d", 1, year(ugeVal) &"/"& month(ugeVal) &"/"& day(ugeVal) &" 9:00:00")
		        cDateAfs = year(now) &"/"& month(now) &"/"& day(now) &" "& time
                 weekafslTxt = "i den følgende uge"
                case "ngf"
                cDateUge = dateadd("d", 2, year(ugeVal) &"/"& month(ugeVal) &"/"& day(ugeVal) &" 12:00:00")
		        cDateAfs = year(now) &"/"& month(now) &"/"& day(now) &" "& time
                weekafslTxt = "i den følgende uge"
		        case else
		        cDateUge = dateadd("d", 1, year(ugeVal) &"/"& month(ugeVal) &"/"& day(ugeVal) &" 9:00:00")
		        cDateAfs = year(now) &"/"& month(now) &"/"& day(now) &" "& time
		         weekafslTxt = "i den følgende uge"
                end select


    end function



	sub opdaterSmiley
	
	
	
    '*** Afslutter uge ****'
        		
    if len(request("FM_afslutuge")) <> 0 then
		        
          
        'sidstedagisidsteuge
		       call rettidigafsl(request("FM_afslutuge_sidstedag"))
		        
		     
		       
        		'if lto = "dencker" then
                'response.write "request(FM_afslutuge_sidstedag)" & request("FM_afslutuge_sidstedag")
                'Response.Write "&nbsp;&nbsp;&nbsp;&nbsp;lto:" & lto & "<br>"& cDateAfs & "<br>"
        		'Response.flush
        		'Response.write "&nbsp;&nbsp;&nbsp;"& cdate(cDateUge) &" >= " & cdate(cDateAfs)
                'end if
        	
		       
        		
		        if cdate(cDateUge) >= cdate(cDateAfs) then
		        intStatusAfs = 2 '** Afsluttet korrekt
		        smileysttxt = "<span style=""color:green;""> er afsluttet korrekt&nbsp;&nbsp;<img src=""../ill/check2.png"" border=0> </span>"
                smileyImg = "gladsmil_2.gif"
		        else
		        intStatusAfs = 1 '** Afsluttet forsent
		        smileysttxt = "<span style=""color:red;""> er afsluttet for sent! </span>"
                smileyImg = "sur_1.gif"
		        end if
		        
		       
        	    'cDateUgeSQL = year(cDateUge) & "/" & month(cDateUge) &"/"& day(cDateUge)	
		        medarbejderid = request("FM_mid")
                call meStamdata(medarbejderid)
        		
		        strSQLafslut = "INSERT INTO ugestatus (uge, afsluttet, mid, status) VALUES ('"& cDateUgeTilAfslutning &"', '"& cDateAfs &"', "& medarbejderid &", "& intStatusAfs &")" 
		        
		        'Response.Write strSQLafslut
		        'Response.flush
		        
		        oConn.execute(strSQLafslut)
		        
		        
		        
		        
		        '*** Godkender automatisk timer i de afsluttede uger **'
		        
		        autogktimer = 0
		        strSQL = "SELECT autogktimer FROM licens WHERE id = 1"
		        oRec3.open strSQL, oConn, 3
		        if not oRec3.EOF then
		        
		        autogktimer = oRec3("autogktimer")
		        
		        end if
		        
		        if cint(autogktimer) = 1 then
		        
		        stDatoGKtimer = cDateUgeTilAfslutning
		        slDatoGKtimer = dateadd("d", -6, cDateUgeTilAfslutning)
		        
		        slDatoGKtimer = year(slDatoGKtimer) &"/"& month(slDatoGKtimer) &"/"& day(slDatoGKtimer)
		        
		        
		        strSQLGKtimer = "UPDATE timer SET godkendtstatus = 1, godkendtstatusaf = '"& session("user") &"' WHERE"_
		        &" tmnr = "& medarbejderid &" AND tdato BETWEEN '"& slDatoGKtimer &"' AND '"& stDatoGKtimer &"'"
		        
		        oConn.execute(strSQLGKtimer)
		       
        		end if
        		
        		
			        '*** Afslut alle uger frem til dd. ****
			        if len(request("FM_alleuger")) <> 0 then
			        afslutalle = request("FM_alleuger")
			        else
			        afslutalle = 0
			        end if
        			
			        
			        if afslutalle = 1 then
        					
                            

					        detteAar = year(request("FM_afslutuge_sidstedag"))
                            
                            sidsteUgeAfsl = request("FM_afslutuge_sidstedag")
                            nuMinusSyv = dateAdd("d", -7, now)
                            
                            'response.write "detteAar: "& detteAar & "<br>"    

                            dayOfWeekThis = datePart("w",now,2,2)
        
                            '1 = (dayOfWeek - d) 
                            dThis = (dayOfWeekThis - 1)
                            firstdayOfFirstWeekThis = dateAdd("d", -dThis, now)
                            firstThursdayOfFirstWeekThis = dateAdd("d", +6, firstdayOfFirstWeekThis)
            
                            sidstedagisidsteAfsluge = firstThursdayOfFirstWeekThis


                            denneugeLast = dateAdd("d", -7, sidstedagisidsteAfsluge)
					        denneuge = datepart("ww", denneugeLast, 2, 2) 'cDateUge
					        denneugeOpr = denneuge
        					
                            'response.write "nuMinusSyv: "& nuMinusSyv & "<br>"

                            PeriodeInterVal = dateDiff("ww", sidsteUgeAfsl, nuMinusSyv, 2,2)

                            'response.write "PeriodeInterVal: "& PeriodeInterVal & "<br>"

					        for u = 0 to PeriodeInterVal 'denneuge 
        					
					        nyDateUge = dateadd("d", (u*(-7)), denneugeLast) 'cDateUge
					        denneuge = datepart("ww", nyDateUge, 2, 2)
					        detteaar = datepart("yyyy", nyDateUge, 2,3)
        					
					        ugefindes = 0
					        strSQL2 = "SELECT u.id, u.status, u.afsluttet, u.uge FROM ugestatus u WHERE YEAR(u.uge) = '"& detteaar &"' AND  WEEK(u.uge, 1) = '"& denneuge &"' AND u.mid = "& medarbejderid
					        'Response.write strSQL2 & "<br>"
        					
					        oRec2.open strSQL2, oConn, 3 
					        if not oRec2.EOF then
					        ugefindes = 1 
					        'Response.write oRec2("id") &" :: "& oRec2("uge") & " - "& datepart("ww", oRec2("uge"), 2, 2) & " - ok!<br>"
				            end if
					        oRec2.close 
        					
					        'Response.Write  denneuge &"<"& denneugeOpr &" AND ugefindes: "& ugefindes &" nyDateUge:"&nyDateUge&" uge: "& datepart("ww", nyDateUge, 2,2) &" meAnsatDato: "& meAnsatDato &" ansatuge: "& datepart("ww", meAnsatDato, 2,2) &"<br>"
                            'response.flush 
                      
        					'cint(denneuge) <= cint(denneugeOpr) AND 
						            if cint(ugefindes) = 0 AND ((datepart("ww", nyDateUge, 2,2) >= datepart("ww", meAnsatDato, 2,2) AND datepart("yyyy", nyDateUge, 2,2) = datepart("yyyy", meAnsatDato, 2,2)) OR datepart("yyyy", nyDateUge, 2,2) > datepart("yyyy", meAnsatDato, 2,2)) then
							        
                                    sqlDateUge = year(nyDateUge)&"/"&month(nyDateUge)&"/"&day(nyDateUge)
        		
							        intStatusAfs = 1 '** Afsl. forsent
							        strSQLafslut = "INSERT INTO ugestatus (uge, afsluttet, mid, status) VALUES ('"& sqlDateUge &"', '"& cDateAfs &"', "& medarbejderid &", "& intStatusAfs &")" 
							        oConn.execute(strSQLafslut)


                                    'response.write "strSQLafslut:<br> "& strSQLafslut & "<br><hr>"

							        'Response.write sqlDateUge &"-"& datepart("ww", nyDateUge, 2, 2) &" Afslutte uge<br>"
							                
							                
							                if cint(autogktimer) = 1 then
		        
		                                    stDatoGKtimer = sqlDateUge
		                                    slDatoGKtimer = dateadd("d", -6, sqlDateUge)
                            		        
		                                    slDatoGKtimer = year(slDatoGKtimer) &"/"& month(slDatoGKtimer) &"/"& day(slDatoGKtimer)
                            		        
                            		        
		                                    strSQLGKtimer = "UPDATE timer SET godkendtstatus = 1, godkendtstatusaf = '"& session("user") &"' WHERE"_
		                                    &" tmnr = "& medarbejderid &" AND tdato BETWEEN '"& slDatoGKtimer &"' AND '"& stDatoGKtimer &"'"
                            		        
                            		        
		                                    oConn.execute(strSQLGKtimer)
		                                    
		                                    
                            		       
        		                            end if
							                    
							        
							        end if
							        
							        
							        
        					
					        next
        					
        					
        					      'Response.end
        					
			        end if
	
	    end if
	    
	end sub 
	
	
	
	
	
	
	
	function tottimer(lastMnavn, lastMnr, totalhours, totalmin, lastMid, sqlDatoStart, sqlDatoslut, vis)
		
		totalmin = (60 * totalhours) + totalmin
		lonTimer = totalmin
		call timerogminutberegning(totalmin)
		
		if showTot = 1 then
		csp = 6
		else
		csp = 9
		end if

        if cint(vis) = 1 then 'total / else uge sum
		trBg = "#ffdfdf"
        else
        trBg = "#FFFFFF"
        end if
		
        
         if vis = 1 then 'total / else uge sum%>

        	<tr>
		<td bgcolor="#cccccc" colspan="<%=csp+3%>" style="height:1px;"></td>
	</tr>
	<%end if %>

    <%  if vis = 1 OR vis = 2 then  %>
	<tr bgcolor="<%=trBg %>">
		<td>&nbsp;</td>
		<td align=right colspan=<%=csp-4%> style="padding:2px;">Løntimer ialt: (stempelur)</td>
		<td align=right><b><%=thoursTot%>:<%=left(tminTot, 2)%></b></td>
		<%if showTot <> 1 then%>	
		<td>&nbsp;</td>
		<td>&nbsp;</td>
		<td>&nbsp;</td>
        <td>&nbsp;</td>
		<%end if %>
		<td>&nbsp;</td>
	 </tr>
	
    <%end if 
    
    
         if vis = 1 then%>

	 <tr bgcolor="<%=trbg %>">
		<td>&nbsp;</td>
		<td align=right colspan=<%=csp-4%> style="padding:2px;">Fradrag til løntimer: (realiseret)</td>
		<td align=right>
		<%
		call akttyper2009(2)
		
		tiltimer = 0
        
            stDtKriTL = year(sqlDatoStart)&"/"&month(sqlDatoStart)&"/"&day(sqlDatoStart)
            slDtKriTL = year(sqlDatoSlut)&"/"&month(sqlDatoSlut)&"/"&day(sqlDatoSlut)

		strSQL2 = "SELECT sum(t.timer) AS tiltimer FROM timer t WHERE "_
		&" (tmnr = "& lastMid &" AND tdato BETWEEN '"& stDtKriTL &"' AND '"& slDtKriTL &"' AND ("& aty_sql_tilwhours &")) GROUP BY tmnr " 
		
            'if session("mid") = 1 then
            'Response.Write strSQL2
		'Response.flush
		'end if

		oRec2.open strSQL2, oConn, 3 
		if not oRec2.EOF then
			tiltimer = oRec2("tiltimer")
		end if
		oRec2.close 
		
		if len(trim(tiltimer)) <> 0 then
		tiltimer = tiltimer
		else
		tiltimer = 0
		end if
		
		fradtimer = 0
		strSQL2 = "SELECT sum(timer) AS fratimer FROM timer t WHERE "_
		&" (tmnr = "& lastMid &" AND tdato BETWEEN '"& stDtKriTL &"' AND '"& slDtKriTL &"' AND ("& aty_sql_frawhours &")) GROUP BY tmnr "
		'Response.Write strSQL2
		'Response.flush
		
		oRec2.open strSQL2, oConn, 3 
		if not oRec2.EOF then
			fradtimer = oRec2("fratimer")
		end if
		oRec2.close 
		
		if len(trim(fradtimer)) <> 0 then
		fradtimer = fradtimer
		else
		fradtimer = 0
		end if
		
		'Response.Write "fradtimer" & fradtimer & "# tilt#"& tiltimer
		
		totalmin = (60 * (-(fradtimer) + (tiltimer)))
		fradragTil = totalmin
		call timerogminutberegning(totalmin)
		
		%>
		&nbsp;&nbsp;<%=thoursTot%>:<%=left(tminTot, 2)%>
		
		
		</td>
		<%if showTot <> 1 then%>
		<td>&nbsp;</td>
		<td>&nbsp;</td>
		<td>&nbsp;</td>
        <td>&nbsp;</td>
		<%end if %>
		<td>&nbsp;</td>
	 </tr>
	 
	  <tr bgcolor="<%=trBg %>">
		<td>&nbsp;</td>
		<td align=right colspan=<%=csp-4%> style="padding:2px;">Løntimer efter fradrag:</td>
		<td align=right>
	 <%'*** Løn Timer minus fradarg *** %>
		<%lonTimerBeregnet = lonTimer + (fradragTil)
		call timerogminutberegning(lonTimerBeregnet) %>
		&nbsp;&nbsp;<u><b><%=thoursTot%>:<%=left(tminTot, 2)%></b></u>
		</td>
		<%if showTot <> 1 then%>
		<td>&nbsp;</td>
		<td>&nbsp;</td>
		<td>&nbsp;</td>
        <td>&nbsp;</td>
		<%end if %>
		<td>&nbsp;</td>
	 </tr>
	 
	 <%if lto <> "cst" then %>
	 
	  <tr bgcolor="<%=trBg %>">
		<td>&nbsp;</td>
		<td align=right colspan=<%=csp-4%> style="padding:2px;">Realiseret timer i samme periode:</td>
		<td align=right>
		<%
		
		
		regtimer = 0
		strSQL2 = "SELECT sum(timer) AS sumtimer FROM timer WHERE tmnr = "& lastMid &" AND tdato BETWEEN '"& stDtKriTL &"' AND '"& slDtKriTL &"' AND ("& aty_sql_realhours &") "
		'Response.Write strSQL2
		'Response.flush
		
		oRec2.open strSQL2, oConn, 3 
		if not oRec2.EOF then
			regtimer = oRec2("sumtimer")
		end if
		oRec2.close 
		
		totalmin = (60 * regtimer)
		call timerogminutberegning(totalmin)
		
		%>
		&nbsp;&nbsp;<%=thoursTot%>:<%=left(tminTot, 2)%>
		</td>
		<%if showTot <> 1 then%>
		<td>&nbsp;</td>
		<td>&nbsp;</td>
		<td>&nbsp;</td>
        <td>&nbsp;</td>
		<%end if %>
		<td>&nbsp;</td>
	 </tr>
	 <%end if %>
	 
     <%end if 'VIS: uge 2 ell. tot 1 %>

	<%
    Response.flush
	end function
	
	
	
	%>