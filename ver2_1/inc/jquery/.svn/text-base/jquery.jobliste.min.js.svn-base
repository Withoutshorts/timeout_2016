var pxMulti = 2; var AddJobListDB = new Array(); var BeginDateOffset; var EndDateOffset; var BeginDate; var EndDate; function parseDate(c) { try { var a = c.split("-"); return new Date(a[2], a[1] - 1, a[0]) } catch (b) { return c } } function daydiff(b, a) { return (a.getTime() - b.getTime()) / (1000 * 60 * 60 * 24) } function CheckIntVal(a) { if (a == undefined) { a = 0 } return a } function IsValidDate(a) { var b = a.split("/")[0]; var e = a.split("/")[1]; var c = a.split("/")[2]; var f; var d = new Date(c, e - 1, b); if ((d.getMonth() + 1 != e) || (d.getDate() != b) || (d.getFullYear() != c)) { alert("Forkert datoformat, skriv venligst dd/mm/yyyy eller d/m/yyyy"); f = false } else { f = true } return f } function positionMarker(e, c) { var a; var f; var d; (c.startdate != null && c.enddate != null && c.enddate != undefined && c.enddate != "") ? a = true : a = false; if (c.alternatestartdate != null) { var b = parseDate(c.alternatestartdate); f = (daydiff(b, parseDate(c.startdate)) * pxMulti) } else { f = (daydiff(BeginDate, parseDate(c.startdate)) * pxMulti) + BeginDateOffset.left } if (c.absmarkcorr) { if ($.browser.msie) { f -= 11 } } if (a) { d = daydiff(parseDate(c.startdate), parseDate(c.enddate)) * pxMulti } e.show(); if (e.hasClass("ui-icon-seek-next") || e.hasClass("ui-icon-seek-prev")) { e.removeClass("ui-icon-orange").removeClass("ui-icon-seek-next").removeClass("ui-icon-seek-prev") } if (a) { if (f + d < BeginDateOffset.left) { (e.parent(".job").length > 0) ? e.hide().parent(".job").remove() : f = BeginDateOffset.left, d = 16, e.css("overflow", "hidden").progressbar("destroy").addClass("ui-icon-orange").addClass("ui-icon-seek-next") } else { if (f < BeginDateOffset.left) { d = d - (BeginDateOffset.left - f); f = BeginDateOffset.left } } if (f > EndDateOffset.left) { (e.parent(".job").length > 0) ? e.hide().parent(".job").remove() : f = EndDateOffset.left, d = 10, e.css("overflow", "hidden").progressbar("destroy").addClass("ui-icon-orange").addClass("ui-icon-seek-prev") } else { if (f + d > EndDateOffset.left) { d = EndDateOffset.left - f } } e.width(d) } e.css("left", f) } $.fn.makeMilePael = function(b) { var a = $(this); b.absmarkcorr = true; b.datatype = "milepole"; a.attr("title", "(" + b.startdate + ") " + b.name + " - " + b.type); positionMarker(a, b) }; $.fn.makePercentBar = function(f) { var e = $(this); var d = Math.round((100 / f.precalc) * f.realised); isFinite(d) ? d = d : (f.realised > f.precalc) ? d = 100 : d = 0; e.attr("title", f.startdate + " - " + f.enddate).progressbar({ value: d }).children(".ui-progressbar-value").text(d + "%").css("text-align", "center"); if (d > 100) { e.css({ borderColor: "#FF8F8F" }); e.children(".ui-progressbar-value").css({ borderColor: "#CF0000", background: "#FF1F1F url(../inc/jquery/images/ui-bg_gloss-wave_45_e14f1c_500x100.png) repeat-x scroll 50% 50%" }) } if (d == 100) { e.css({ borderColor: "#B2FF5F" }); e.children(".ui-progressbar-value").css({ borderColor: "#4B8F00", background: "#FF1F1F url(../inc/jquery/images/ui-bg_gloss-wave_50_6eac2c_500x100.png) repeat-x scroll 50% 50%" }) } if (f.jobresp1 != null) { var i = f.jobresp1.split("-"); var h = i[1]; var b = i[2]; var c = f.jobresp2.split("-"); var g = c[1]; var a = c[2]; e.siblings(".percentInfo").html("forkalk: " + f.precalc + " real: " + f.realised + " res: " + f.resource + " pri: " + f.prioritet + "<br />jobans:<a class='vmenu' href='mailto:" + b + "'>" + h + "</a>, <a class='vmenu' href='mailto:" + a + "'>" + g + "</a>") } else { e.siblings(".percentInfo").html("forkalk: " + f.precalc + " real: " + f.realised + "") } positionMarker(e, f, true); $(".job:odd").css({ "background-color": "#EFF3FF", "border-top": "1px solid #ccc", "border-bottom": "1px solid #ccc" }); $(".job:even").css({ "background-color": "#FFF", border: "0" }); $("#todayMarker").height($("#JobGraph").height()) }; function AddJobs() { var B = AddJobListDB; var p = B.length; while (p--) { var l = B[p].ArrActivities; var t = B[p].ArrMilePael; var k = B[p].customer; var C = B[p].name; var h = B[p].jid; var d = B[p].precalc; var m = B[p].realised; var b = B[p].resource; var A = B[p].startdate; var q = B[p].enddate; var r = B[p].jnr; var x = B[p].cnr; var s = B[p].prioritet; var a = B[p].jobresp1.split("-"); var y = a[1]; var g = a[2]; var e = B[p].jobresp2.split("-"); var w = e[1]; var z = e[2]; var o = ""; for (var u = 0, n = t.length; u < n; u++) { o += "<div class='ui-icon-orange ui-icon-flag milepael' style='position:absolute' ></div>" } $("#JobGraph").append("<div class='job'><span class='jobInfo' style='font-weight:bold'>" + (k + " (" + x + ")") + "<br /><a href='jobs.asp?menu=job&func=red&id=" + h + "&int=1&rdir=webblik_joblisten2' class='vmenu' title='" + C + " (" + r + ")' target='_blank'>" + (C + " (" + r + ")").substring(0, 31) + "</a></span>" + o + "<div class='percentBar' title='" + A + " - " + q + "'></div><span class='percentInfo'></span><br class='clear' /><div class='activities'><img class='loadingActivityIcon' src='../inc/jquery/images/ajax-loader.gif' alt='henter data'/></div><center class='clear'><div class='closeOpenIcon ui-icon ui-icon-carat-1-s' /></center></div>"); var c = $("#JobGraph div.job:last"); if (s == -1) { c.fadeTo(1, 0.8) } c.data("dataElm", B[p]); var v = c.children("div.activities"); c.children("div.percentBar").makePercentBar(B[p]); if (c.length > 0) { if ((p / 7).toString().indexOf(".") == -1 && p + 5 < B.length) { try { $("#JobGraphHeader").clone().css("margin", "5px 0px 5px 0px").insertAfter(c) } catch (f) { } } } c.children("div.milepael").each(function(i) { $(this).data("dataElm", t[i]).makeMilePael(t[i]) }) } $("#JobGraph .loadingIcon").remove(); $("#JobGraph .activities").hide(); $("#JobGraph").append("<div id='jobDialog' title='ændring af dato'><p>Datoen på <span class='jobName'>0</span> vil blive ændret <span class='jobNotice'>0</span></p><br /><span id='ajaxFromDate'>Fra:<br /><input type='text' id='ajaxStartDate' /></span><br /><span id='ajaxToDate'>Til:<br /><input type='text' id='ajaxEndDate' /></span></div>"); $("#JobGraph .closeOpenIcon").toggle(function() { var I = $(this).parent().parent(".job"); I.children(".activities").stop().slideDown(200, function() { $("#todayMarker").height($("#JobGraph").height()) }); if (!(I.hasClass("hasActivities"))) { var E = I.data("dataElm"); var H = E.ArrActivities; var G = ""; for (var F = 0, D = H.length; F < D; F++) { G += "<br class='clear' /><div class='activity'><span class='jobInfo' title='" + (H[F].name + " (#" + H[F].id + ")") + "'>" + (H[F].name + " (" + H[F].id + ")").substring(0, 31) + "</span><div class='percentBar' title='" + H[F].startdate + " - " + H[F].enddate + "'></div><span class='percentInfo'></span></div>" } G += '<br class="clear" /><div style="border: 1px solid rgb(140, 170, 230); padding: 3px; margin:3px; float:left; width: 130px; background-color: rgb(255, 255, 255);"><table width="100%" cellspacing="0" cellpadding="0" border="0"><tbody><tr><td><a target="_top" alt="Opret ny aktivitet" class="vmenu" href="aktiv.asp?menu=job&amp;func=opret&amp;jobid=' + E.jid + "&amp;id=0&amp;jobnavn=" + E.name + '&amp;fb=1&amp;rdir=">Opret ny aktivitet</a></td><td style="padding: 3px 0px 0px;"><a target="_top" alt="Opret ny aktivitet" class="vmenu" href="aktiv.asp?menu=job&amp;func=opret&amp;jobid=' + E.jid + "&amp;id=0&amp;jobnavn=" + E.name + '&amp;fb=1&amp;rdir="><img border="0" src="../ill/add2.png"/></a></td></tr></tbody></table></div>'; G += '<div style="border: 1px solid rgb(140, 170, 230); padding: 3px; margin:3px; float:left; width: 140px; background-color: rgb(255, 255, 255);"><table width="100%" cellspacing="0" cellpadding="0" border="0"><tbody><tr><td><a target="_top" alt="Opret ny Milep�l" class="vmenu" href=\'javascript:popUp("milepale.asp?menu=job&amp;func=opr&amp;jid=' + E.jid + '&amp;rdir=webblik","650","500","250","120");\'>Opret ny Milep�l</a></td><td style="padding: 3px 0px 0px;"><a target="_top" alt="Opret ny Milep�l" class="vmenu" href=\'javascript:popUp("milepale.asp?menu=job&amp;func=opr&amp;jid=' + E.jid + '&amp;rdir=webblik","650","500","250","120");\'><img border="0" src="../ill/add2.png"/></a></td></tr></tbody></table></div>'; I.children(".activities").html(G).children(".activity").each(function(i) { $(this).data("dataElm", H[i]); $(this).children("div.percentBar").makePercentBar(H[i]) }); j(); I.addClass("hasActivities") } $(this).removeClass("ui-icon-carat-1-s").addClass("ui-icon-carat-1-n") }, function() { var i = $(this).parent().parent(".job"); i.children(".activities").stop().slideUp(200, function() { $("#todayMarker").height($("#JobGraph").height()) }); $(this).removeClass("ui-icon-carat-1-n").addClass("ui-icon-carat-1-s") }); function j() { var E; var G; var D; var i; var F; $(".percentBar, .milepael").draggable({ axis: "x", start: function() { G = $(this).filter(".percentBar"); i = $(this).filter(".milepael"); D = G.parent(".job").children(".activities").children(".activity"); F = G.parent(".activity").parent(".activities").parent(".job"); E = $(this).offset(); if ($(this).parent(".job").children(".activities").css("display") == "none") { $(this).parent(".job").click() } }, stop: function() { var K = new Date(BeginDate); var H = $(this).offset(); var J; ($(this).data("dataElm") != null) ? J = $(this).data("dataElm") : J = $(this).parent().data("dataElm"); var I; (J.startdate != null && J.enddate != null) ? I = true : I = false; if (I) { var L = Math.round(daydiff(parseDate(J.startdate), parseDate(J.enddate))) } K.setDate(K.getDate() + ((H.left - BeginDateOffset.left - 20) / pxMulti)); $("#jobDialog .jobName").html(J.name); J.jid != undefined ? jobNotice = " eventuelle underaktiviteter vil blive rykket med" : jobNotice = ""; $("#jobDialog #ajaxEndDate").val($.datepicker.formatDate("d/m/yy", K)).change(function() { try { var M = $.datepicker.parseDate("dd/mm/yy", $("#ajaxEndDate").val()); $(".ui-dialog-buttonpane button:first").disabled = false } catch (N) { alert("forkert datoformat skriv venligst d/m/åå eller dd/mm/yy"); $(".ui-dialog-buttonpane button:first").disabled = true } }); $("#jobDialog #ajaxEndDate").change(); I ? $("#jobDialog #ajaxToDate").show() : $("#jobDialog #ajaxToDate").hide(); $("#jobDialog #ajaxStartDate").val($.datepicker.formatDate("d/m/yy", K)).change(function() { try { var M = $.datepicker.parseDate("dd/mm/yy", $("#ajaxStartDate").val()); M.setDate(M.getDate() + L); $("#jobDialog #ajaxEndDate").val($.datepicker.formatDate("d/m/yy", M)); $(".ui-dialog-buttonpane button:first").disabled = false } catch (N) { alert("forkert datoformat skriv venligst d/m/åå eller dd/mm/yy"); $(".ui-dialog-buttonpane button:first").disabled = true } }); $("#jobDialog #ajaxStartDate").change(); $("#jobDialog .jobNotice").html(jobNotice); $("#jobDialog").dialog("option", "buttons", { Accept: function() { var M = $.datepicker.parseDate("dd/mm/yy", $("#jobDialog #ajaxStartDate").val()); if (I) { var P = $.datepicker.parseDate("dd/mm/yy", $("#jobDialog #ajaxEndDate").val()) } var O = Math.round(daydiff(parseDate(J.startdate), M)); $.post("?", "jid=" + J.jid + "&cnr=" + J.cnr + "&dateDiff=" + O + "&id=" + J.id + "&startdate = " + $.datepicker.formatDate("yy/mm/d", M) + "&enddate = " + $.datepicker.formatDate("yy/mm/d", P) + "&func=ajaxupdate&datatype=" + J.datatype + "&ajid=" + J.ajid); $(this).dialog("close"); if (I) { D.each(function() { var Q = $(this).data("dataElm"); Q.startdate = $.datepicker.parseDate("dd-mm-yy", Q.startdate); (Q.startdate).setDate(((Q.startdate).getDate() + O)); Q.startdate = $.datepicker.formatDate("dd-mm-yy", Q.startdate); Q.enddate = $.datepicker.parseDate("dd-mm-yy", Q.enddate); (Q.enddate).setDate((Q.enddate).getDate() + O); Q.enddate = $.datepicker.formatDate("dd-mm-yy", Q.enddate); $(this).children(".percentBar").makePercentBar(Q); $(this).data("dataElm", Q) }); G.parent().children(".milepael").each(function() { var Q = $(this).data("dataElm"); Q.startdate = $.datepicker.parseDate("dd-mm-yy", Q.startdate); (Q.startdate).setDate(((Q.startdate).getDate() + O)); Q.startdate = $.datepicker.formatDate("dd-mm-yy", Q.startdate); $(this).data("dataElm", Q).makeMilePael(Q) }); J.startdate = $.datepicker.formatDate("dd-mm-yy", M); if (G.length > 0) { J.enddate = $("#ajaxEndDate").val().replace("/", "-").replace("/", "-"); G.parent(".job").data("dataElm", J); G.makePercentBar(J); var N = F.data("dataElm"); if (($.datepicker.parseDate("dd-mm-yy", J.startdate)).getTime() < ($.datepicker.parseDate("dd-mm-yy", N.startdate)).getTime()) { N.startdate = J.startdate } if (($.datepicker.parseDate("dd-mm-yy", J.enddate)).getTime() > ($.datepicker.parseDate("dd-mm-yy", N.enddate)).getTime()) { N.enddate = J.enddate } F.data("dataElm", N); F.children(".percentBar").makePercentBar(N) } if (i.length > 0) { i.data("dataElm", J).makeMilePael(J) } } }, Cancel: function() { $(this).dialog("close"); if (G.length > 0) { G.makePercentBar(J) } if (i.length > 0) { i.makeMilePael(J) } } }); $("#jobDialog").dialog("open") } }) } j(); $("#jobDialog").dialog({ bgiframe: true, resizable: true, autoOpen: false, height: 400, modal: true, overlay: { backgroundColor: "#000", opacity: 0.5 }, buttons: { Accept: function() { $(this).dialog("close") }, Cancel: function() { $(this).dialog("close"); $(this).css({ left: ObjOffset.left, top: ObjOffset.top }) } } }); $.datepicker.setDefaults($.extend({ showAnim: "slide", showOptions: { direction: "drop" }, duration: -50, showOn: "button", constrainInput: true, showOtherMonths: true, showWeeks: true, minDate: new Date(2002, 1, 1), firstDay: 1, changeFirstDay: false, buttonImage: "../ill/popupcal.gif", start: 6, buttonImageOnly: true, dateFormat: "d/m/yy", changeMonth: true, changeYear: true })); $("#ajaxStartDate").datepicker(); $("#ajaxEndDate").datepicker(); $("#JobGraph .ui-icon").hover(function() { $(this).removeClass("ui-icon").addClass("ui-icon-orange") }, function() { $(this).removeClass("ui-icon-orange").addClass("ui-icon") }) } function PopulateGraphFrame() { var h = $("#FM_startdate"); var g = $.datepicker.parseDate("d/m/yy", h.val()); $("#navPrevMonth").click(function() { g.setMonth(g.getMonth() - 3); h.val($.datepicker.formatDate("d/m/yy", g)); var j = h.val(); var i = j.split("/"); $("#FM_start_dag").val(i[0]); $("#FM_start_mrd").val(i[1]); $("#FM_start_aar").val(i[2]); $("form").submit() }); $("#navNextMonth").click(function() { g.setMonth(g.getMonth() + 3); $("#FM_startdate").val($.datepicker.formatDate("d/m/yy", g)); var j = h.val(); var i = j.split("/"); $("#FM_start_dag").val(i[0]); $("#FM_start_mrd").val(i[1]); $("#FM_start_aar").val(i[2]); $("form").submit() }); var a = $.datepicker.parseDate("d/m/yy", h.val()); a.setMonth(a.getMonth() - 6); a.setDate(1); MonthArr = new Array("", ""); var e = new Array("Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"); for (var f = 0; f < 13; f++) { a.setMonth(a.getMonth() + f); MonthArr[f] = { days: c(a.getMonth() + 1, a.getFullYear()), name: e[a.getMonth()] + " " + a.getFullYear(), date: a }; a.setMonth(a.getMonth() - f); $("#JobGraphHeader").append("<li class='month'>&nbsp;</li>"); var d = $("#JobGraphHeader li.month:last"); d.width(((MonthArr[f].days) * pxMulti) - 1).text(MonthArr[f].name).data("date", MonthArr[f].date); if (f == 0) { BeginDate = new Date(MonthArr[f].date); BeginDateOffset = d.offset(); BeginDateOffset.left = BeginDateOffset.left - 20 } if (f == 12) { EndDate = new Date(MonthArr[f].date); EndDate.setMonth(EndDate.getMonth() + 12); EndDateOffset = d.offset(); EndDateOffset.left += d.width(); EndDateOffset.left -= 20 } } function c(k, j) { var i = new Date(j, k, 0); return i.getDate() } var b = new Date(); if (BeginDate.getTime() < b.getTime() && b.getTime() < EndDate.getTime()) { $("#JobGraph").prepend("<div title='d.d.' id='todayMarker' style='width:1px;'></div>"); positionMarker($("#todayMarker"), { startdate: b, absmarkcorr: true }); $("#JobGraphHeader").append("<li class='infoField' style='border-right:0;'>Timer</li>") } } $(window).load(function() { PopulateGraphFrame(); AddJobs(); $("#todayMarker").height($("#JobGraph").height()); $("#tilLabel").hide(); $("#FM_enddate").css("display", "none") });